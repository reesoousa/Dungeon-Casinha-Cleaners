<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dungeon Cleaners RPG</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --color-primary: #F7D707;
            --color-background: #F2E6D6;
            --color-info: #3B95D9;
            --color-success: #95C95D;
            --color-white: #FFFFFF;
            --color-danger: #EF476F;
            
            --stroke: 3px solid #1a1a1a;
            --stroke-thin: 2px solid #1a1a1a;
            --shadow: 4px 4px 0px #1a1a1a;
            --shadow-hover: 6px 6px 0px #1a1a1a;
            --card-shadow: 8px 8px 0px #1a1a1a;
            --color-text: #1a1a1a;
            
            --gradient-easy: linear-gradient(135deg, #95C95D 0%, #7AB04A 100%);
            --gradient-medium: linear-gradient(135deg, #3B95D9 0%, #2B7AB8 100%);
            --gradient-hard: linear-gradient(135deg, #EF476F 0%, #D63659 100%);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Nunito', sans-serif;
            background: var(--color-background);
            color: var(--color-text);
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }
        
        h1, h2, h3 {
            font-family: 'Fredoka One', cursive;
            letter-spacing: 0.5px;
        }
        
        /* ============================================
           BUTTONS
        ============================================ */
        .btn {
            background: var(--color-white);
            border: var(--stroke);
            box-shadow: var(--shadow);
            padding: 14px 28px;
            font-family: 'Fredoka One', cursive;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transition: left 0.3s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: var(--shadow-hover);
        }
        
        .btn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #1a1a1a;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .btn-primary { background-color: var(--color-primary); }
        .btn-info { background-color: var(--color-info); color: white; }
        .btn-success { background-color: var(--color-success); color: white; }
        .btn-danger { background-color: var(--color-danger); color: white; }
        
        .btn-small {
            padding: 10px 18px;
            font-size: 0.85rem;
        }
        
        .btn-block {
            width: 100%;
        }
        
        .icon-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            transition: all 0.2s;
        }
        
        .icon-btn:hover {
            background: rgba(0, 0, 0, 0.08);
            transform: scale(1.1);
        }
        
        .icon-btn:active {
            transform: scale(0.95);
        }
        
        /* ============================================
           LAYOUT
        ============================================ */
        .container {
            max-width: 680px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 120px;
        }
        
        /* ============================================
           HEADER
        ============================================ */
        header {
            background: var(--color-white);
            border-bottom: var(--stroke);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .logo {
            font-family: 'Fredoka One';
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .gold-display {
            background: var(--color-primary);
            border: var(--stroke-thin);
            padding: 10px 20px;
            border-radius: 50px;
            font-family: 'Fredoka One';
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 0 #1a1a1a;
        }
        
        /* ============================================
           SCREENS
        ============================================ */
        .screen {
            display: none;
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .screen.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        /* ============================================
           SETUP SCREEN
        ============================================ */
        .setup-box {
            background: var(--color-white);
            border: var(--stroke);
            box-shadow: var(--card-shadow);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            margin-top: 60px;
        }
        
        .setup-box h1 {
            font-size: 2.5rem;
            margin-bottom: 12px;
            color: var(--color-text);
        }
        
        .setup-box p {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 30px;
        }
        
        input {
            width: 100%;
            padding: 18px;
            border: var(--stroke);
            border-radius: 12px;
            font-family: 'Nunito', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 16px;
            outline: none;
            background: var(--color-white);
            transition: all 0.2s;
        }
        
        input:focus {
            border-color: var(--color-info);
            box-shadow: 0 0 0 3px rgba(59, 149, 217, 0.2);
        }
        
        /* ============================================
           ACTIONS AREA
        ============================================ */
        .actions-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 32px;
        }
        
        .actions-area .btn {
            padding: 20px;
            font-size: 1.1rem;
        }
        
        .section-title {
            margin-bottom: 20px;
            font-size: 1.6rem;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--color-text);
        }
        
        /* ============================================
           TCG CARDS (MONSTROS NA MESA)
        ============================================ */
        .card-grid {
            display: grid;
            gap: 20px;
        }
        
        .tcg-card {
            background: var(--color-white);
            border: var(--stroke);
            box-shadow: var(--shadow);
            border-radius: 16px;
            padding: 0;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .tcg-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--card-shadow);
        }
        
        .tcg-card-header {
            padding: 20px;
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .tcg-card-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
            animation: shine 3s infinite;
        }
        
        @keyframes shine {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(30%, 30%); }
        }
        
        .tcg-card-header.easy { background: var(--gradient-easy); }
        .tcg-card-header.medium { background: var(--gradient-medium); }
        .tcg-card-header.hard { background: var(--gradient-hard); }
        
        .card-title {
            font-size: 1.4rem;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .card-difficulty {
            background: rgba(0,0,0,0.2);
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
        }
        
        .tcg-card-body {
            padding: 20px;
        }
        
        .card-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .loot-badge {
            background: var(--color-primary);
            border: var(--stroke-thin);
            padding: 8px 16px;
            border-radius: 12px;
            font-weight: 800;
            font-size: 1.1rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 0 #1a1a1a;
        }
        
        .card-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        /* ============================================
           MODAL DE SELEÇÃO
        ============================================ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(4px);
        }
        
        .modal-overlay.open {
            opacity: 1;
            pointer-events: all;
        }
        
        .modal {
            background: var(--color-white);
            border: var(--stroke);
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 32px;
            border-radius: 20px;
            width: 92%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .modal-overlay.open .modal {
            transform: scale(1);
        }
        
        .modal h2 {
            font-size: 2rem;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .modal-subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 28px;
            font-size: 1.05rem;
        }
        
        /* Cards de Seleção no Modal */
        .task-selection-grid {
            display: grid;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .task-selection-card {
            background: var(--color-white);
            border: var(--stroke);
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow);
        }
        
        .task-selection-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: var(--card-shadow);
        }
        
        .task-selection-card:active {
            transform: translateY(0) scale(0.98);
        }
        
        .task-selection-header {
            padding: 24px 20px;
            color: white;
            position: relative;
        }
        
        .task-selection-header.easy { background: var(--gradient-easy); }
        .task-selection-header.medium { background: var(--gradient-medium); }
        .task-selection-header.hard { background: var(--gradient-hard); }
        
        .task-selection-title {
            font-size: 1.35rem;
            margin-bottom: 10px;
            font-weight: 800;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .task-selection-body {
            padding: 18px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* ============================================
           MANAGEMENT MODAL
        ============================================ */
        .management-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .management-item {
            background: var(--color-background);
            border: var(--stroke-thin);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .management-item-info {
            flex: 1;
        }
        
        .management-item h4 {
            font-size: 1.1rem;
            margin-bottom: 4px;
        }
        
        .management-item-meta {
            display: flex;
            gap: 12px;
            font-size: 0.9rem;
            color: #666;
        }
        
        /* ============================================
           SHOP
        ============================================ */
        .shop-item {
            background: var(--color-white);
            border: var(--stroke);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            box-shadow: var(--shadow);
        }
        
        .shop-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
        
        .shop-item-info h3 {
            font-size: 1.3rem;
            margin-bottom: 6px;
        }
        
        .cost {
            color: var(--color-danger);
            font-weight: 800;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .shop-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .add-reward-card {
            background: var(--color-info);
            color: white;
            border-color: #1a1a1a;
            margin-bottom: 24px;
        }
        
        .add-reward-card h3 {
            color: white;
        }
        
        .add-reward-card p {
            color: rgba(255, 255, 255, 0.9);
            margin-top: 4px;
        }
        
        /* ============================================
           HISTORY
        ============================================ */
        .history-tabs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .history-tab {
            padding: 16px;
            background: var(--color-white);
            border: var(--stroke);
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            font-weight: 700;
            font-size: 1.05rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .history-tab:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .history-tab.active {
            background: var(--color-info);
            color: white;
            box-shadow: var(--shadow);
        }
        
        .history-list {
            display: none;
        }
        
        .history-list.active {
            display: block;
        }
        
        .history-item {
            background: var(--color-white);
            border: var(--stroke);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
        }
        
        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .history-player {
            font-weight: 800;
            font-size: 1.1rem;
        }
        
        .history-item-date {
            font-size: 0.85rem;
            color: #666;
            font-weight: 600;
        }
        
        .history-task {
            font-size: 1.05rem;
            margin-bottom: 10px;
            color: #333;
        }
        
        /* ============================================
           NAVIGATION
        ============================================ */
        .bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--color-white);
            border: var(--stroke);
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            border-radius: 50px;
            padding: 8px;
            display: flex;
            gap: 6px;
            z-index: 200;
        }
        
        .nav-btn {
            padding: 12px 20px;
            border-radius: 40px;
            border: none;
            background: transparent;
            font-family: 'Fredoka One';
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            color: var(--color-text);
        }
        
        .nav-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }
        
        .nav-btn.active {
            background: var(--color-text);
            color: white;
        }
        
        /* ============================================
           UTILS
        ============================================ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            opacity: 0.6;
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-state-text {
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .pulse {
            animation: pulse 0.3s ease;
        }
        
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--color-background);
        }
        
        ::-webkit-scrollbar-thumb {
            background: #1a1a1a;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #2a2a2a;
        }
        
        @media (max-width: 640px) {
            .container {
                padding: 16px;
                padding-bottom: 100px;
            }
            
            .setup-box {
                padding: 28px;
                margin-top: 40px;
            }
            
            .setup-box h1 {
                font-size: 2rem;
            }
            
            .modal {
                padding: 24px;
            }
            
            .nav-btn span {
                display: none;
            }
            
            .bottom-nav {
                bottom: 12px;
            }
            
            .actions-area {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header id="app-header" style="display:none;">
        <div class="logo">
            <i data-lucide="castle" style="width: 26px; height: 26px;"></i>
            <span>DUNGEON CLEANERS</span>
        </div>
        <div class="gold-display">
            <i data-lucide="coins" style="width: 22px; height: 22px;"></i>
            <span id="total-gold">0</span>
        </div>
    </header>
    
    <div class="container">
        <!-- SETUP SCREEN -->
        <div id="screen-setup" class="screen active">
            <div class="setup-box">
                <h1>
                    <i data-lucide="sword" style="width: 28px; height: 28px;"></i>
                    Bem-vindos!
                </h1>
                <p>Quem vai limpar a masmorra hoje?</p>
                <div style="margin-top: 30px;">
                    <input type="text" id="p1-name" placeholder="Nome do Jogador 1" value="Renan">
                    <input type="text" id="p2-name" placeholder="Nome do Jogador 2" value="Daisy">
                    <button class="btn btn-primary btn-block" onclick="startGame()">
                        <i data-lucide="play" style="width: 22px; height: 22px;"></i>
                        Começar Aventura
                    </button>
                </div>
            </div>
        </div>
        
        <!-- DUNGEON SCREEN -->
        <div id="screen-dungeon" class="screen">
            <div class="actions-area">
                <button class="btn btn-info" onclick="openTaskModal()">
                    <i data-lucide="sword" style="width: 24px; height: 24px;"></i>
                    Invocar Tarefa
                </button>
                <button class="btn btn-primary" onclick="openManagementModal()">
                    <i data-lucide="settings" style="width: 24px; height: 24px;"></i>
                    Gerenciar
                </button>
            </div>
            
            <div class="section-title">
                <i data-lucide="flame" style="width: 30px; height: 30px;"></i>
                <span>Monstros na Mesa</span>
            </div>
            
            <div id="active-monsters" class="card-grid"></div>
            
            <div id="empty-dungeon" class="empty-state">
                <div class="empty-state-icon">
                    <i data-lucide="castle" style="width: 64px; height: 64px;"></i>
                </div>
                <div class="empty-state-text">
                    A casa está limpa... por enquanto.<br>
                    <strong>Clique em "Invocar Tarefa"</strong> para começar!
                </div>
            </div>
        </div>
        
        <!-- TAVERN SCREEN -->
        <div id="screen-tavern" class="screen">
            <div class="section-title">
                <i data-lucide="shopping-bag" style="width: 30px; height: 30px;"></i>
                <span>Recompensas</span>
            </div>
            
            <div class="shop-item add-reward-card">
                <div class="shop-item-info">
                    <h3>Nova Recompensa</h3>
                    <p>Adicionar item à Wishlist</p>
                </div>
                <button class="btn" style="padding: 12px 20px;" onclick="addCustomReward()">
                    <i data-lucide="plus" style="width: 22px; height: 22px;"></i>
                </button>
            </div>
            
            <div id="shop-list"></div>
        </div>
        
        <!-- HISTORY SCREEN -->
        <div id="screen-history" class="screen">
            <div class="section-title">
                <i data-lucide="scroll-text" style="width: 30px; height: 30px;"></i>
                <span>Histórico</span>
            </div>
            
            <div class="history-tabs">
                <div class="history-tab active" onclick="switchHistoryTab('activity')">
                    <i data-lucide="check-circle" style="width: 18px; height: 18px;"></i>
                    <span>Atividades</span>
                </div>
                <div class="history-tab" onclick="switchHistoryTab('purchase')">
                    <i data-lucide="shopping-cart" style="width: 18px; height: 18px;"></i>
                    <span>Compras</span>
                </div>
            </div>
            
            <div id="activity-log" class="history-list active"></div>
            <div id="purchase-history" class="history-list"></div>
        </div>
    </div>
    
    <!-- MODAL DE SELEÇÃO DE TAREFA -->
    <div id="task-modal" class="modal-overlay" onclick="handleModalOutsideClick(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <h2>
                <i data-lucide="cards" style="width: 24px; height: 24px;"></i>
                Escolha uma Tarefa
            </h2>
            <p class="modal-subtitle">Toque em uma das cartas para invocar o monstro</p>
            <div id="task-selection-cards" class="task-selection-grid"></div>
            <button class="btn btn-block" onclick="closeTaskModal()">
                <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                Cancelar
            </button>
        </div>
    </div>
    
    <!-- MODAL DE GERENCIAMENTO -->
    <div id="management-modal" class="modal-overlay" onclick="handleManagementOutsideClick(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <h2>
                <i data-lucide="settings" style="width: 24px; height: 24px;"></i>
                Gerenciar Monstros
            </h2>
            <p class="modal-subtitle">Remova tarefas da mesa ou limpe tudo</p>
            
            <div class="management-list" id="management-list"></div>
            
            <button class="btn btn-danger btn-block" onclick="clearAllMonsters()" style="margin-bottom: 10px;">
                <i data-lucide="trash-2" style="width: 20px; height: 20px;"></i>
                Limpar Todos os Monstros
            </button>
            
            <button class="btn btn-block" onclick="closeManagementModal()">
                <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                Fechar
            </button>
        </div>
    </div>
    
    <!-- NAVIGATION -->
    <nav class="bottom-nav" id="main-nav" style="display:none;">
        <button class="nav-btn active" onclick="switchTab('dungeon')">
            <i data-lucide="castle" style="width: 20px; height: 20px;"></i>
            <span>MASMORRA</span>
        </button>
        <button class="nav-btn" onclick="switchTab('tavern')">
            <i data-lucide="shopping-bag" style="width: 20px; height: 20px;"></i>
            <span>TAVERNA</span>
        </button>
        <button class="nav-btn" onclick="switchTab('history')">
            <i data-lucide="scroll-text" style="width: 20px; height: 20px;"></i>
            <span>HISTÓRICO</span>
        </button>
        <button class="nav-btn" onclick="hardReset()">
            <i data-lucide="rotate-ccw" style="width: 20px; height: 20px;"></i>
        </button>
    </nav>
    
    <script>
        // ============================================
        // BANCO DE DADOS EXPANDIDO (20+ tarefas por nível)
        // ============================================
        const TASK_DATABASE = {
            easy: [
                { name: "Tirar o Lixo", loot: 10, difficulty: "easy" },
                { name: "Arrumar a Cama", loot: 10, difficulty: "easy" },
                { name: "Guardar Sapatos", loot: 8, difficulty: "easy" },
                { name: "Organizar Controles", loot: 8, difficulty: "easy" },
                { name: "Regar as Plantas", loot: 12, difficulty: "easy" },
                { name: "Guardar Louça Limpa", loot: 10, difficulty: "easy" },
                { name: "Dobrar Panos de Prato", loot: 8, difficulty: "easy" },
                { name: "Organizar Revistas", loot: 9, difficulty: "easy" },
                { name: "Limpar Espelho", loot: 11, difficulty: "easy" },
                { name: "Guardar Brinquedos", loot: 10, difficulty: "easy" },
                { name: "Organizar Almofadas", loot: 7, difficulty: "easy" },
                { name: "Tirar Pó da Mesa", loot: 9, difficulty: "easy" },
                { name: "Organizar Livros", loot: 10, difficulty: "easy" },
                { name: "Limpar Porta", loot: 8, difficulty: "easy" },
                { name: "Organizar Chinelos", loot: 7, difficulty: "easy" },
                { name: "Limpar Teclado", loot: 9, difficulty: "easy" },
                { name: "Organizar Cabos", loot: 10, difficulty: "easy" },
                { name: "Limpar Monitor", loot: 9, difficulty: "easy" },
                { name: "Organizar Porta-Trecos", loot: 8, difficulty: "easy" },
                { name: "Limpar Interruptor", loot: 7, difficulty: "easy" }
            ],
            medium: [
                { name: "Organizar a Mesa", loot: 25, difficulty: "medium" },
                { name: "Dobrar Roupas", loot: 30, difficulty: "medium" },
                { name: "Lavar a Louça", loot: 28, difficulty: "medium" },
                { name: "Limpar a Pia", loot: 22, difficulty: "medium" },
                { name: "Organizar Gavetas", loot: 26, difficulty: "medium" },
                { name: "Passar Aspirador", loot: 30, difficulty: "medium" },
                { name: "Limpar Fogão", loot: 32, difficulty: "medium" },
                { name: "Organizar Guarda-Roupa", loot: 28, difficulty: "medium" },
                { name: "Limpar Janelas", loot: 30, difficulty: "medium" },
                { name: "Organizar Despensa", loot: 27, difficulty: "medium" },
                { name: "Limpar Microondas", loot: 24, difficulty: "medium" },
                { name: "Passar Pano nos Móveis", loot: 26, difficulty: "medium" },
                { name: "Organizar Armário", loot: 29, difficulty: "medium" },
                { name: "Limpar Estantes", loot: 25, difficulty: "medium" },
                { name: "Organizar Freezer", loot: 28, difficulty: "medium" },
                { name: "Limpar Box do Banheiro", loot: 30, difficulty: "medium" },
                { name: "Trocar Lençóis", loot: 23, difficulty: "medium" },
                { name: "Limpar Ventilador", loot: 26, difficulty: "medium" },
                { name: "Organizar Prateleiras", loot: 27, difficulty: "medium" },
                { name: "Limpar Tapetes", loot: 29, difficulty: "medium" }
            ],
            hard: [
                { name: "Varrer/Passar Pano", loot: 50, difficulty: "hard" },
                { name: "Limpar o Banheiro", loot: 60, difficulty: "hard" },
                { name: "Limpar a Cozinha", loot: 65, difficulty: "hard" },
                { name: "Aspirar Casa Toda", loot: 55, difficulty: "hard" },
                { name: "Limpar a Geladeira", loot: 70, difficulty: "hard" },
                { name: "Lavar/Estender Roupa", loot: 45, difficulty: "hard" },
                { name: "Limpar Azulejos", loot: 58, difficulty: "hard" },
                { name: "Organizar Closet Completo", loot: 62, difficulty: "hard" },
                { name: "Limpar Área Externa", loot: 68, difficulty: "hard" },
                { name: "Faxina na Sala", loot: 56, difficulty: "hard" },
                { name: "Limpar Todos os Vidros", loot: 54, difficulty: "hard" },
                { name: "Organizar Garagem", loot: 66, difficulty: "hard" },
                { name: "Limpar Armários por Dentro", loot: 60, difficulty: "hard" },
                { name: "Faxina no Quarto", loot: 52, difficulty: "hard" },
                { name: "Limpar Paredes", loot: 58, difficulty: "hard" },
                { name: "Organizar Documentos", loot: 48, difficulty: "hard" },
                { name: "Limpar Ar Condicionado", loot: 55, difficulty: "hard" },
                { name: "Faxina Geral na Casa", loot: 75, difficulty: "hard" },
                { name: "Limpar Quintal", loot: 64, difficulty: "hard" },
                { name: "Organizar Depósito", loot: 70, difficulty: "hard" }
            ]
        };
        
        const INITIAL_SHOP = [
            { id: 1, name: "Pedir Pizza", cost: 200 },
            { id: 2, name: "Vale Massagem", cost: 100 },
            { id: 3, name: "Cinema", cost: 150 }
        ];
        
        let gameState = {
            players: [],
            gold: 0,
            activeMonsters: [],
            shopItems: JSON.parse(JSON.stringify(INITIAL_SHOP)),
            initialized: false,
            activityLog: [],
            purchaseHistory: []
        };
        
        // ============================================
        // INICIALIZAÇÃO - CORRIGIDO PARA EVITAR ERRO LUCIDE
        // ============================================
        function initIcons() {
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            } else {
                setTimeout(initIcons, 100);
            }
        }
        
        function init() {
            const saved = localStorage.getItem('dungeonCleanersSave');
            if (saved) {
                try {
                    gameState = JSON.parse(saved);
                    
                    if (!gameState.activityLog) gameState.activityLog = [];
                    if (!gameState.purchaseHistory) gameState.purchaseHistory = [];
                    
                    if (gameState.initialized) {
                        showGameInterface();
                        renderDungeon();
                        renderShop();
                        renderHistory();
                        updateGold();
                    }
                } catch (e) {
                    console.error('Erro ao carregar save:', e);
                }
            }
            
            initIcons();
        }
        
        function saveGame() {
            try {
                localStorage.setItem('dungeonCleanersSave', JSON.stringify(gameState));
                updateGold();
            } catch (e) {
                console.error('Erro ao salvar:', e);
            }
        }
        
        function startGame() {
            const p1 = document.getElementById('p1-name').value.trim() || "Jogador 1";
            const p2 = document.getElementById('p2-name').value.trim() || "Jogador 2";
            
            gameState.players = [p1, p2];
            gameState.initialized = true;
            
            saveGame();
            showGameInterface();
            renderDungeon();
            renderShop();
            renderHistory();
            
            setTimeout(initIcons, 100);
        }
        
        function showGameInterface() {
            document.getElementById('screen-setup').classList.remove('active');
            document.getElementById('screen-dungeon').classList.add('active');
            document.getElementById('app-header').style.display = 'flex';
            document.getElementById('main-nav').style.display = 'flex';
            
            initIcons();
        }
        
        function switchTab(tab) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`screen-${tab}`).classList.add('active');
            
            const btns = document.querySelectorAll('.nav-btn');
            if (tab === 'dungeon') btns[0].classList.add('active');
            if (tab === 'tavern') btns[1].classList.add('active');
            if (tab === 'history') btns[2].classList.add('active');
            
            if (tab === 'history') renderHistory();
            
            setTimeout(initIcons, 50);
        }
        
        // ============================================
        // MODAL DE INVOCAÇÃO - RANDOMIZAÇÃO EXPANDIDA
        // ============================================
        function openTaskModal() {
            const modal = document.getElementById('task-modal');
            const container = document.getElementById('task-selection-cards');
            container.innerHTML = '';
            
            // Função para pegar tarefa aleatória sem repetir as 3 últimas
            function getRandomTask(difficulty) {
                const pool = TASK_DATABASE[difficulty];
                const availableTasks = pool.filter(task => {
                    return !gameState.activeMonsters.some(m => m.name === task.name);
                });
                
                if (availableTasks.length === 0) return pool[Math.floor(Math.random() * pool.length)];
                return availableTasks[Math.floor(Math.random() * availableTasks.length)];
            }
            
            const easyTask = getRandomTask('easy');
            const mediumTask = getRandomTask('medium');
            const hardTask = getRandomTask('hard');
            
            const tasks = [easyTask, mediumTask, hardTask];
            
            const difficultyLabels = {
                easy: 'Fácil',
                medium: 'Médio',
                hard: 'Difícil'
            };
            
            tasks.forEach(task => {
                const card = document.createElement('div');
                card.className = 'task-selection-card';
                card.onclick = () => selectTask(task);
                
                card.innerHTML = `
                    <div class="task-selection-header ${task.difficulty}">
                        <div class="task-selection-title">${task.name}</div>
                        <div class="card-difficulty">${difficultyLabels[task.difficulty]}</div>
                    </div>
                    <div class="task-selection-body">
                        <span style="font-weight: 700; font-size: 1.05rem;">Recompensa:</span>
                        <div class="loot-badge">
                            <i data-lucide="coins" style="width: 16px; height: 16px;"></i>
                            +${task.loot}
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
            
            modal.classList.add('open');
            setTimeout(initIcons, 50);
        }
        
        function closeTaskModal() {
            document.getElementById('task-modal').classList.remove('open');
        }
        
        function handleModalOutsideClick(event) {
            if (event.target.id === 'task-modal') {
                closeTaskModal();
            }
        }
        
        function selectTask(task) {
            const instanceTask = {
                ...task,
                id: Date.now() + Math.random()
            };
            
            gameState.activeMonsters.push(instanceTask);
            saveGame();
            
            // FECHA O MODAL IMEDIATAMENTE
            closeTaskModal();
            
            // Renderiza depois de fechar
            setTimeout(() => {
                renderDungeon();
                document.getElementById('total-gold').classList.add('pulse');
                setTimeout(() => {
                    document.getElementById('total-gold').classList.remove('pulse');
                }, 300);
            }, 100);
        }
        
        // ============================================
        // MODAL DE GERENCIAMENTO
        // ============================================
        function openManagementModal() {
            const modal = document.getElementById('management-modal');
            const container = document.getElementById('management-list');
            container.innerHTML = '';
            
            if (gameState.activeMonsters.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-text">Nenhum monstro na mesa</div>
                    </div>
                `;
            } else {
                const difficultyLabels = {
                    easy: 'Fácil',
                    medium: 'Médio',
                    hard: 'Difícil'
                };
                
                gameState.activeMonsters.forEach((monster, index) => {
                    const item = document.createElement('div');
                    item.className = 'management-item';
                    
                    item.innerHTML = `
                        <div class="management-item-info">
                            <h4>${monster.name}</h4>
                            <div class="management-item-meta">
                                <span class="card-difficulty ${monster.difficulty}">${difficultyLabels[monster.difficulty]}</span>
                                <span class="loot-badge">
                                    <i data-lucide="coins" style="width: 14px; height: 14px;"></i>
                                    ${monster.loot}
                                </span>
                            </div>
                        </div>
                        <button class="icon-btn" onclick="removeMonster(${monster.id})">
                            <i data-lucide="trash-2" style="width: 24px; height: 24px; color: #EF476F;"></i>
                        </button>
                    `;
                    
                    container.appendChild(item);
                });
            }
            
            modal.classList.add('open');
            setTimeout(initIcons, 50);
        }
        
        function closeManagementModal() {
            document.getElementById('management-modal').classList.remove('open');
        }
        
        function handleManagementOutsideClick(event) {
            if (event.target.id === 'management-modal') {
                closeManagementModal();
            }
        }
        
        function removeMonster(id) {
            const index = gameState.activeMonsters.findIndex(m => m.id === id);
            if (index !== -1) {
                const monster = gameState.activeMonsters[index];
                if (confirm(`Remover "${monster.name}" da mesa?`)) {
                    gameState.activeMonsters.splice(index, 1);
                    saveGame();
                    renderDungeon();
                    openManagementModal(); // Recarrega o modal
                }
            }
        }
        
        function clearAllMonsters() {
            if (gameState.activeMonsters.length === 0) {
                alert('Não há monstros para limpar!');
                return;
            }
            
            if (confirm(`Remover TODOS os ${gameState.activeMonsters.length} monstros da mesa?`)) {
                gameState.activeMonsters = [];
                saveGame();
                renderDungeon();
                closeManagementModal();
            }
        }
        
        // ============================================
        // MECÂNICA: MASMORRA
        // ============================================
        function killMonster(id, playerIndex) {
            const monsterIndex = gameState.activeMonsters.findIndex(m => m.id === id);
            if (monsterIndex === -1) return;
            
            const monster = gameState.activeMonsters[monsterIndex];
            const player = gameState.players[playerIndex];
            
            gameState.gold += monster.loot;
            
            gameState.activityLog.unshift({
                player: player,
                task: monster.name,
                gold: monster.loot,
                date: new Date().toISOString()
            });
            
            gameState.activeMonsters.splice(monsterIndex, 1);
            
            saveGame();
            renderDungeon();
            renderHistory();
            
            document.getElementById('total-gold').classList.add('pulse');
            setTimeout(() => {
                document.getElementById('total-gold').classList.remove('pulse');
            }, 300);
        }
        
        function renderDungeon() {
            const container = document.getElementById('active-monsters');
            const emptyState = document.getElementById('empty-dungeon');
            
            container.innerHTML = '';
            
            if (gameState.activeMonsters.length === 0) {
                emptyState.style.display = 'block';
                return;
            } else {
                emptyState.style.display = 'none';
            }
            
            const difficultyLabels = {
                easy: 'Fácil',
                medium: 'Médio',
                hard: 'Difícil'
            };
            
            gameState.activeMonsters.forEach(monster => {
                const card = document.createElement('div');
                card.className = 'tcg-card';
                
                card.innerHTML = `
                    <div class="tcg-card-header ${monster.difficulty}">
                        <div class="card-title">${monster.name}</div>
                        <div class="card-difficulty">${difficultyLabels[monster.difficulty]}</div>
                    </div>
                    <div class="tcg-card-body">
                        <div class="card-stats">
                            <span style="font-weight: 700;">Recompensa:</span>
                            <div class="loot-badge">
                                <i data-lucide="coins" style="width: 16px; height: 16px;"></i>
                                ${monster.loot}
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-success btn-small" onclick="killMonster(${monster.id}, 0)">
                                <i data-lucide="check" style="width: 16px; height: 16px;"></i>
                                ${gameState.players[0]}
                            </button>
                            <button class="btn btn-success btn-small" onclick="killMonster(${monster.id}, 1)">
                                <i data-lucide="check" style="width: 16px; height: 16px;"></i>
                                ${gameState.players[1]}
                            </button>
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
            
            initIcons();
        }
        
        // ============================================
        // SHOP
        // ============================================
        function renderShop() {
            const container = document.getElementById('shop-list');
            container.innerHTML = '';
            
            gameState.shopItems.forEach((item, index) => {
                const el = document.createElement('div');
                el.className = 'shop-item';
                const canBuy = gameState.gold >= item.cost;
                
                el.innerHTML = `
                    <div class="shop-item-info">
                        <h3>${item.name}</h3>
                        <div class="cost">
                            <i data-lucide="coins" style="width: 18px; height: 18px;"></i>
                            ${item.cost}
                        </div>
                    </div>
                    <div class="shop-actions">
                        <button class="btn btn-primary btn-small ${canBuy ? '' : ''}" 
                            ${canBuy ? '' : 'disabled'}
                            onclick="buyItem(${index})">
                            <i data-lucide="shopping-cart" style="width: 18px; height: 18px;"></i>
                            Comprar
                        </button>
                        <button class="icon-btn" onclick="deleteShopItem(${index})">
                            <i data-lucide="trash-2" style="width: 22px; height: 22px; color: #EF476F;"></i>
                        </button>
                    </div>
                `;
                
                container.appendChild(el);
            });
            
            initIcons();
        }
        
        function buyItem(index) {
            const item = gameState.shopItems[index];
            if (gameState.gold < item.cost) {
                alert("Ouro insuficiente! Vá limpar a casa!");
                return;
            }
            
            if (confirm(`Comprar "${item.name}" por ${item.cost} moedas?`)) {
                gameState.gold -= item.cost;
                
                gameState.purchaseHistory.unshift({
                    item: item.name,
                    cost: item.cost,
                    date: new Date().toISOString()
                });
                
                saveGame();
                renderShop();
                renderHistory();
                
                alert(`Compra realizada!\n"${item.name}" desbloqueado!`);
            }
        }
        
        function addCustomReward() {
            const name = prompt("Nome da Recompensa:\n(ex: Jantar no Japonês)");
            if (!name || !name.trim()) return;
            
            const cost = prompt("Custo em Ouro:\n(ex: 300)");
            if (!cost || isNaN(cost) || cost <= 0) {
                alert("Valor inválido!");
                return;
            }
            
            gameState.shopItems.push({
                id: Date.now(),
                name: name.trim(),
                cost: parseInt(cost)
            });
            
            saveGame();
            renderShop();
        }
        
        function deleteShopItem(index) {
            const item = gameState.shopItems[index];
            if (confirm(`Excluir "${item.name}" da loja?`)) {
                gameState.shopItems.splice(index, 1);
                saveGame();
                renderShop();
            }
        }
        
        // ============================================
        // HISTORY
        // ============================================
        function switchHistoryTab(tab) {
            document.querySelectorAll('.history-tab').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.history-list').forEach(el => el.classList.remove('active'));
            
            if (tab === 'activity') {
                document.querySelectorAll('.history-tab')[0].classList.add('active');
                document.getElementById('activity-log').classList.add('active');
            } else {
                document.querySelectorAll('.history-tab')[1].classList.add('active');
                document.getElementById('purchase-history').classList.add('active');
            }
            
            initIcons();
        }
        
        function renderHistory() {
            renderActivityLog();
            renderPurchaseHistory();
        }
        
        function renderActivityLog() {
            const container = document.getElementById('activity-log');
            container.innerHTML = '';
            
            if (gameState.activityLog.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i data-lucide="scroll-text" style="width: 64px; height: 64px;"></i>
                        </div>
                        <div class="empty-state-text">Nenhuma tarefa concluída ainda</div>
                    </div>
                `;
                initIcons();
                return;
            }
            
            gameState.activityLog.forEach(entry => {
                const el = document.createElement('div');
                el.className = 'history-item';
                
                const date = new Date(entry.date);
                const dateStr = date.toLocaleDateString('pt-BR', { 
                    day: '2-digit', 
                    month: '2-digit',
                    year: '2-digit',
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                el.innerHTML = `
                    <div class="history-item-header">
                        <span class="history-player">${entry.player}</span>
                        <span class="history-item-date">${dateStr}</span>
                    </div>
                    <div class="history-task">${entry.task}</div>
                    <div class="loot-badge">
                        <i data-lucide="coins" style="width: 14px; height: 14px;"></i>
                        +${entry.gold}
                    </div>
                `;
                
                container.appendChild(el);
            });
            
            initIcons();
        }
        
        function renderPurchaseHistory() {
            const container = document.getElementById('purchase-history');
            container.innerHTML = '';
            
            if (gameState.purchaseHistory.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i data-lucide="shopping-cart" style="width: 64px; height: 64px;"></i>
                        </div>
                        <div class="empty-state-text">Nenhuma compra realizada ainda</div>
                    </div>
                `;
                initIcons();
                return;
            }
            
            gameState.purchaseHistory.forEach(entry => {
                const el = document.createElement('div');
                el.className = 'history-item';
                
                const date = new Date(entry.date);
                const dateStr = date.toLocaleDateString('pt-BR', { 
                    day: '2-digit', 
                    month: '2-digit',
                    year: '2-digit',
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                el.innerHTML = `
                    <div class="history-item-header">
                        <span class="history-player">${entry.item}</span>
                        <span class="history-item-date">${dateStr}</span>
                    </div>
                    <div class="cost">
                        <i data-lucide="coins" style="width: 16px; height: 16px;"></i>
                        -${entry.cost}
                    </div>
                `;
                
                container.appendChild(el);
            });
            
            initIcons();
        }
        
        // ============================================
        // UTILS
        // ============================================
        function updateGold() {
            document.getElementById('total-gold').textContent = gameState.gold;
        }
        
        function hardReset() {
            if (confirm("⚠️ TEM CERTEZA?\n\nIsso vai apagar TODO o progresso, ouro, e histórico!")) {
                localStorage.removeItem('dungeonCleanersSave');
                location.reload();
            }
        }
        
        // Aguarda o DOM e Lucide carregarem completamente
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
